<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Enrollment - QR Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¸ Face Enrollment</h1>
            <p>Register your face and voice for attendance verification</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="instructions">
            <h3>Instructions:</h3>
            <ul>
                <li>Position your face in the center of the camera</li>
                <li>Ensure good lighting on your face</li>
                <li>Wait for the green "Face Detected" status</li>
                <li>Click "Start Listening" and speak the phrase shown</li>
                <li>Click "Capture & Enroll" when both are verified</li>
            </ul>
        </div>

        <div class="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay" class="camera-overlay"></canvas>
            <div id="faceStatus" class="face-status waiting">
                <span class="spinner"></span>
                <span>Initializing camera...</span>
            </div>
        </div>

        <form id="enrollForm" class="form-container" method="POST">
            <div class="form-group">
                <label for="name">Full Name *</label>
                <input type="text" id="name" name="name" required placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label for="student_id">Student ID *</label>
                <input type="text" id="student_id" name="student_id" required placeholder="Enter your student ID">
            </div>

            <input type="hidden" id="faceDescriptor" name="face_descriptor" required>
            <input type="hidden" id="speechVerified" name="speech_verified" value="false">

            <button type="submit" id="submitBtn" class="btn btn-primary btn-block" disabled>
                <span id="btnText">Capture & Enroll</span>
            </button>

            <div style="margin-top: 1rem; text-align: center;">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
            </div>
        </form>
    </div>

    <script src="{{ url_for('static', filename='js/face-api.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/face-verification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/voice-recorder.js') }}"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const faceStatus = document.getElementById('faceStatus');
        const submitBtn = document.getElementById('submitBtn');
        const faceDescriptorInput = document.getElementById('faceDescriptor');
        const speechVerifiedInput = document.getElementById('speechVerified');
        const enrollForm = document.getElementById('enrollForm');

        // Add Speech UI dynamically
        const cameraContainer = document.querySelector('.camera-container');
        const speechContainer = document.createElement('div');
        speechContainer.className = 'speech-container';
        speechContainer.style.marginTop = '1.5rem';
        speechContainer.style.textAlign = 'center';
        speechContainer.innerHTML = `
            <h3>ðŸŽ¤ Speech Verification</h3>
            <p>Please speak this phrase clearly:</p>
            <p id="targetPhrase" class="phrase" style="font-weight: bold; font-size: 1.2rem; margin: 1rem 0; color: var(--primary-color);">Loading...</p>
            <button type="button" id="listenBtn" class="btn btn-secondary">Start Listening</button>
            <div id="speechStatus" style="margin-top: 0.5rem; color: var(--text-gray);">Ready to listen</div>
            <div id="transcriptBox" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px; display: none;">
                <div style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">You said:</div>
                <div id="transcript" style="font-style: italic;"></div>
            </div>
        `;
        cameraContainer.parentNode.insertBefore(speechContainer, enrollForm);

        const listenBtn = document.getElementById('listenBtn');
        const speechStatus = document.getElementById('speechStatus');
        const targetPhraseEl = document.getElementById('targetPhrase');
        const transcriptBox = document.getElementById('transcriptBox');
        const transcriptEl = document.getElementById('transcript');

        const faceVerification = new FaceVerification();
        const speechVerifier = new SpeechVerifier();

        let detectionInterval = null;
        let faceDetected = false;
        let speechVerified = false;

        // Initialize speech verifier
        try {
            speechVerifier.init();
            const phrase = speechVerifier.generatePhrase();
            targetPhraseEl.textContent = `"${phrase}"`;
        } catch (e) {
            speechStatus.textContent = 'Speech recognition not supported in this browser';
            speechStatus.style.color = 'var(--danger-color)';
            listenBtn.disabled = true;
        }

        // Update status message
        function updateStatus(message, type = 'waiting') {
            faceStatus.className = `face-status ${type}`;
            faceStatus.innerHTML = type === 'waiting' ?
                `<span class="spinner"></span><span>${message}</span>` :
                `<span>${message}</span>`;
        }

        // Initialize
        async function init() {
            try {
                updateStatus('Loading face recognition models...', 'waiting');
                await faceVerification.loadModels();

                updateStatus('Starting camera...', 'waiting');
                await faceVerification.startVideo(video);

                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                updateStatus('Position your face in the frame', 'detecting');

                // Start continuous detection
                detectionInterval = faceVerification.startContinuousDetection(onDetection, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus(error.message, 'error');
            }
        }

        // Handle face detection
        function onDetection(detection) {
            if (detection) {
                faceDetected = true;
                updateStatus('âœ“ Face Detected - Ready to capture!', 'verified');
                checkReady();

                // Draw detection box
                faceVerification.drawDetection(detection, canvas);
            } else {
                faceDetected = false;
                updateStatus('No face detected - Please position your face', 'detecting');
                checkReady();

                // Clear canvas
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Speech Recognition Logic
        listenBtn.addEventListener('click', () => {
            if (!speechVerifier.isListening) {
                listenBtn.disabled = true;
                listenBtn.textContent = 'Listening...';
                listenBtn.className = 'btn btn-primary';
                speechStatus.textContent = 'ðŸŽ™ï¸ Listening... Speak now!';
                speechStatus.style.color = 'var(--primary-color)';
                transcriptBox.style.display = 'none';

                speechVerifier.startListening(
                    (result) => {
                        // Success
                        transcriptEl.textContent = `"${result.transcript}"`;
                        transcriptBox.style.display = 'block';

                        if (result.matched) {
                            speechVerified = true;
                            speechVerifiedInput.value = 'true';
                            listenBtn.textContent = 'âœ“ Speech Verified';
                            listenBtn.className = 'btn btn-success';
                            speechStatus.textContent = `âœ“ Match! (${Math.round(result.matchPercentage)}%)`;
                            speechStatus.style.color = 'var(--success-color)';
                        } else {
                            speechVerified = false;
                            speechVerifiedInput.value = 'false';
                            listenBtn.textContent = 'Try Again';
                            listenBtn.className = 'btn btn-warning';
                            listenBtn.disabled = false;
                            speechStatus.textContent = `âŒ Didn't match (${Math.round(result.matchPercentage)}%)`;
                            speechStatus.style.color = 'var(--danger-color)';
                        }
                        checkReady();
                    },
                    (error) => {
                        // Error
                        listenBtn.textContent = 'Try Again';
                        listenBtn.className = 'btn btn-secondary';
                        listenBtn.disabled = false;
                        speechStatus.textContent = `Error: ${error}`;
                        speechStatus.style.color = 'var(--danger-color)';
                    }
                );
            }
        });

        function checkReady() {
            if (faceDetected && speechVerified) {
                submitBtn.disabled = false;
                document.getElementById('btnText').textContent = 'Capture & Enroll (Face + Speech)';
            } else if (faceDetected) {
                submitBtn.disabled = false;
                document.getElementById('btnText').textContent = 'Capture & Enroll (Face Only)';
            } else {
                submitBtn.disabled = true;
                document.getElementById('btnText').textContent = 'Detecting Face...';
            }
        }

        // Handle form submission
        enrollForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!faceDetected) {
                alert('Please wait for face detection.');
                return;
            }

            submitBtn.disabled = true;
            updateStatus('Capturing & Uploading...', 'waiting');

            try {
                // Capture face descriptor
                const descriptor = await faceVerification.captureFaceDescriptor();

                if (!descriptor) {
                    throw new Error('Failed to capture face data.');
                }

                // Prepare FormData
                const formData = new FormData(enrollForm);
                formData.set('face_descriptor', JSON.stringify(descriptor));

                // Submit via AJAX
                const response = await fetch('{{ url_for("enroll") }}', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirect;
                } else {
                    throw new Error(result.error || 'Enrollment failed');
                }

            } catch (error) {
                console.error('Enrollment error:', error);
                updateStatus(error.message, 'error');
                submitBtn.disabled = false;
                alert('Error: ' + error.message);
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (detectionInterval) {
                faceVerification.stopContinuousDetection(detectionInterval);
            }
            faceVerification.stopVideo();
        });

        // Start initialization
        init();
    </script>
</body>

</html>